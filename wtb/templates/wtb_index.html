{% extends 'wtb_base.html' %}


{% load static %}



{% block title %} 嘩！找書 {% endblock %}


{% block three %} 

	<script type="module">
		import * as THREE from '{% static "three.js-master/build/three.module.js" %}';//'../build/three.module.js';
		import Stats from '{% static "three.js-master/examples/jsm/libs/stats.module.js" %}';
		import { GUI } from '{% static "three.js-master/examples/jsm/libs/dat.gui.module.js" %}';
		import { OrbitControls } from '{% static "three.js-master/examples/jsm/controls/OrbitControls.js" %}';
		import { Water } from '{% static "three.js-master/examples/jsm/objects/Water.js" %}';
		import { Sky } from '{% static "three.js-master/examples/jsm/objects/Sky.js" %}';
		//threex.domevents.js 有修改首末行的import/export 
		import { THREEx } from '{% static "three.js-master/build/threex.domevents.js" %}';		
		//
		var container, stats;
		var camera, scene, renderer, light;
		var controls, water, sphere;
		//
		init();
		animate();
		//
		function init() {

			container = document.getElementById( 'three_container' );
			//
			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			container.appendChild( renderer.domElement );

			//scene
			scene = new THREE.Scene();
			//camera
			camera = new THREE.PerspectiveCamera( 55, window.innerWidth / window.innerHeight, 1, 20000 );
			//camera.position.set( 30, 30, 100 );
			camera.position.set(0, 0, 60); 
			//light
			light = new THREE.DirectionalLight( 0xffffff, 0.8 );
			scene.add( light );

			// Water
			var waterGeometry = new THREE.PlaneBufferGeometry( 10000, 10000 );

			water = new Water(
				waterGeometry,
				{
					textureWidth: 512,
					textureHeight: 512,
					waterNormals: new THREE.TextureLoader().load( '{% static "three.js-master/examples/textures/waternormals.jpg" %}', function ( texture ) {

						texture.wrapS = texture.wrapT = THREE.RepeatWrapping;

					} ),
					
					alpha: 1.0,
					sunDirection: light.position.clone().normalize(),
					sunColor: 0xffffff,
					waterColor: 0x001e0f,
					distortionScale: 3.7,
					fog: scene.fog !== undefined
				}
			);
			
			water.rotation.x = - Math.PI / 2;
			water.material.uniforms['size'].value=10;//遠景
			scene.add( water );

			// Skybox
			var sky = new Sky();
			var uniforms = sky.material.uniforms;

			uniforms[ 'turbidity' ].value = 10;
			uniforms[ 'rayleigh' ].value = 2;
			uniforms[ 'luminance' ].value = 1;
			uniforms[ 'mieCoefficient' ].value = 0.005;
			uniforms[ 'mieDirectionalG' ].value = 0.8;
			
			//
			var parameters = {
				distance: 400,
				inclination: 0.49,//太陽高度
				azimuth: 0.25//太陽左右
			};

			var cubeCamera = new THREE.CubeCamera( 0.1, 1, 512 );
			cubeCamera.renderTarget.texture.generateMipmaps = true;
			cubeCamera.renderTarget.texture.minFilter = THREE.LinearMipmapLinearFilter;

			scene.background = cubeCamera.renderTarget;

			function updateSun() {

				var theta = Math.PI * ( parameters.inclination - 0.5 );
				var phi = 2 * Math.PI * ( parameters.azimuth - 0.5 );

				light.position.x = parameters.distance * Math.cos( phi );
				light.position.y = parameters.distance * Math.sin( phi ) * Math.sin( theta );
				light.position.z = parameters.distance * Math.sin( phi ) * Math.cos( theta );

				sky.material.uniforms[ 'sunPosition' ].value = light.position.copy( light.position );
				water.material.uniforms[ 'sunDirection' ].value.copy( light.position ).normalize();

				cubeCamera.update( renderer, sky );

			}

			updateSun();

			//

			var geometry = new THREE.IcosahedronBufferGeometry( 20, 1 );
			var count = geometry.attributes.position.count;

			var colors = [];
			var color = new THREE.Color();

			for ( var i = 0; i < count; i += 3 ) {
				color.setHex( Math.random() * 0xffffff );
				//
				colors.push( color.r, color.g, color.b );
				colors.push( color.r, color.g, color.b );
				colors.push( color.r, color.g, color.b );
			}
			
			
			geometry.setAttribute( 'color', new THREE.Float32BufferAttribute( colors, 3 ) );
			
			var material = new THREE.MeshStandardMaterial( {
				vertexColors: true,
				roughness: 0.0,
				flatShading: true,
				envMap: cubeCamera.renderTarget.texture,
				side: THREE.DoubleSide
			} );
			
			sphere = new THREE.Mesh( geometry, material );
			//不加球
			//scene.add( sphere ); 
			
			//logo處理=================================
			var xo=-16;
			var yo=23;			
			if (window.matchMedia("(max-width: 992px)").matches) {
			  var zo=3;
			} else {
			  var zo=20;
			}						
			var Dx=Math.abs(xo/2);
			var Dy=5;
			var Dz=3;
			var grid=5;
            {% for store in stores %}
				//var logo_texture = new THREE.TextureLoader().load("/mystatic/images/RT_logo.png");
				var logo_loader = new THREE.TextureLoader();
				logo_loader.load('{{ store.url_href }}', function ( logo_texture ) {
					var logo_material = new THREE.MeshBasicMaterial( { map: logo_texture,
					                                                   side: THREE.DoubleSide,
																	   wireframe: false 
																   } );
					var w=logo_texture.image.width/40;
					var h=logo_texture.image.height/40;
					//
					var logo_geometry = new THREE.PlaneGeometry(w,h,1,1);
					var logo=new THREE.Mesh(logo_geometry, logo_material);
					//
					logo.position.x=xo+({{forloop.counter0}}%grid)*Dx;					
					logo.position.y=yo-(Math.floor({{forloop.counter0}}/grid))*Dy;
					logo.position.z=zo-({{forloop.counter0}}%2)*Dz;					
					//
					scene.add(logo); 
					//事件綁定
					var domEvents = new THREEx.DomEvents(camera, renderer.domElement);
					//點擊
					domEvents.addEventListener(logo, 'click', function(e){
						window.open('{{ store.url }}', '_blank');						  
					}, false);
					//mouseover
					domEvents.addEventListener(logo, 'mouseover', function(e){
						$("#three_container").css('cursor','pointer').attr("title",'前往{{ store.name }}');						  
					}, false);	
					//mouseout
					domEvents.addEventListener(logo, 'mouseout', function(e){
						$("#three_container").css('cursor','').attr("title","");;						  
					}, false); 	
				
				});//logo_loader
				
            {% endfor %}			
			

			controls = new OrbitControls( camera, renderer.domElement );
			controls.maxPolarAngle = Math.PI * 0.495;
			controls.target.set( 0, 10, 0 );
			controls.minDistance = 40.0;
			controls.maxDistance = 200.0;
			controls.update();

			//

			//stats = new Stats();
			//container.appendChild( stats.dom );

			/* 不要GUI面板
			var gui = new GUI();
			//
			var folder = gui.addFolder( 'Sky' );
			folder.add( parameters, 'inclination', 0, 0.5, 0.0001 ).onChange( updateSun );
			folder.add( parameters, 'azimuth', 0, 1, 0.0001 ).onChange( updateSun );
			folder.open();

			var uniforms = water.material.uniforms;

			var folder = gui.addFolder( 'Water' );
			folder.add( uniforms.distortionScale, 'value', 0, 8, 0.1 ).name( 'distortionScale' );
			folder.add( uniforms.size, 'value', 0.1, 10, 0.1 ).name( 'size' );
			folder.add( uniforms.alpha, 'value', 0.9, 1, .001 ).name( 'alpha' );
			folder.open();
			*/
			//

			window.addEventListener( 'resize', onWindowResize, false );

		}

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function animate() {

			requestAnimationFrame( animate );
			render();
			//stats.update();

		}

		function render() {

			var time = performance.now() * 0.001;

			/*
			sphere.position.y = Math.sin( time ) * 20 + 5;
			sphere.rotation.x = time * 0.5;
			sphere.rotation.z = time * 0.51;
			*/
			water.material.uniforms[ 'time' ].value += 1.0 / 60.0;

			renderer.render( scene, camera );

		}		
	</script>
{% endblock %}



{% block content %} 
	<div id="three_container" style='position:fixed;top:0px;left:0px;z-index:-10;'></div>
	
    <div id='body_store' align='' style="display:none">
        <div>
            <h1>嘩！找書</h1>
            <ol style=''>
                <li style='color:'>
                    <span style='color:black'>
                        本站從下列共{{stores_count}}家網路平台蒐集價目及書籍資料，方便書友比價。
                    </span>
                </li>
                <li style='color:'>
                    <span style='color:black'>
                        請於頁首搜尋欄位輸入關鍵字。
                    </span>
                </li>                
                
            </ol>
        </div>
        <div id='store_logo_area'>
            {% for store in stores %}
                <a href='{{ store.url }}' title='{{ store.name }}' target='_blank'>
                    {% if store.url_logo %}
                        <img class='store_logo' src='{{ store.url_logo }}'/>
                    {% else %}                        
                        <img class='store_logo' src='{{ store.url_href }}'/>
                    {% endif %}
                </a>    
            {% endfor %}
        </div>
    </div>    
    
{% endblock %}

