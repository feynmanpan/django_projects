<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統計室大全</title>
    <style>
        /*  */
        * {
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            /* overflow: hidden; */
            font-family: 微軟正黑體;
            overflow-y: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: row;
        }

        nav {
            width: 230px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: aliceblue;
            box-shadow: 0 1px 6px 0 rgba(32, 33, 36, 1.28);
            overflow-y: hidden;
            position: absolute;
            z-index: 1;
            margin-left: -180px;
            transition: all 0.3s ease;
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        nav:hover {
            margin-left: 0px;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        nav::-webkit-scrollbar {
            display: none;
        }

        .nav_pin {
            position: relative;
            margin-left: 0px;
        }

        #container_items {
            overflow-y: auto;
            padding-bottom: 120px;
        }

        #container_items::-webkit-scrollbar {
            display: none;
        }

        #pin {
            position: absolute;
            right: 4px;
            bottom: 4px;
            font-size: 10px;
            line-height: 10px;
            cursor: pointer;
            color: darkgrey;
        }

        #pin.pin_pin {
            color: darkgreen;
        }

        #menu-title {
            /* background-color: white; */
            border-bottom: 1px solid lightgrey;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 20px;
            color: darkgreen;
            position: relative;
            height: 85px;
            line-height: 65px;
        }

        .menu-item {
            font-size: 15px;
            line-height: 30px;
            height: 30px;
            padding-left: 0.5em;
            border-bottom: 1px solid lightgrey;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .api_item {
            color: blue;
        }

        .menu-item:hover {
            background-color: yellowgreen;
            /* color: white; */
        }

        #container {
            /* border: 1px solid red; */
            /* height: 100%; */
            /* width: 50%; */
            flex: 1;
            padding: 10px;
            margin-left: 50px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #container.container_pin {
            margin-left: 0px;
        }

        iframe {
            width: 100%;
            height: 100%;
        }

        .now {
            /* color: blue; */
            /* font-weight: bold; */
            background-color: gold;
            text-shadow: 0 0 8px #ffffff;
        }

        p.api {
            margin-top: 0;
            margin-bottom: 5px;
            background-color: palegoldenrod;
            padding: 3px;
            font-size: 15px;
        }

        .api input {
            width: 100%;
            vertical-align: bottom;
            margin-top: 1px;
        }

        .api button {
            margin-top: 2px;
            cursor: pointer;
        }

        #apires {
            overflow-y: auto;
            margin-top: 5px;
            height: 100%;
        }

        #apires::-webkit-scrollbar {
            /* display: none; */
        }

        a:visited {
            color: blue;
        }

        #myDataTalbe {
            font-size: 13px;
        }

        #myDataTalbe tbody tr:nth-child(even) {
            background-color: rgba(211, 211, 211, .7);
        }

        #myDataTalbe tbody tr {
            transition: all 0.1s ease;
        }

        #myDataTalbe tbody tr:hover {
            background-color: lightblue;
            cursor: pointer;
            color: red;
        }

        #myDataTalbe thead th {
            border-bottom: 1.5px solid #111;
        }

        #myDataTalbe {
            border-bottom: 1.5px solid #111;
        }

        div.dt-buttons {
            position: relative;
            float: left;
            margin-left: 20px;
        }

        .date {
            display: inline-block;
            width: 200px;
            vertical-align: middle;
        }

        .pigA {
            background: #B80000;
            color: white;
        }

        .pigB {
            background: #E26B0A;
            color: white;
        }

        .pigC {
            background: #31869B;
            color: white;
        }

        .pigDD {
            background: #974706;
            color: white;
        }

        .pigWeb {
            color: red;
        }

        .pigWeb_T {
            color: blue;
        }

        .pig75 {
            background: #C4D79B;
        }

        .pig95 {
            background: #92D050;
        }

        .PR {
            text-align: right;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            /* width: 100px; */
            /* height: 33px; */
            padding: 5px;
            padding-left: 5px;
            /* padding-bottom: 8px; */
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            text-align: left;
        }

        .pigspan {
            display: inline-block;
            width: 7.5em;
        }
    </style>
    <!-- https://github.com/niutech/x-frame-bypass -->
    <script type="module" src="https://unpkg.com/x-frame-bypass"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js'></script>
    <!--  -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/fixedheader/3.1.7/js/dataTables.fixedHeader.min.js"></script>
    <!--  -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.html5.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/6.3.1/d3.min.js'></script>
    <!--  -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.4/css/buttons.dataTables.min.css" />

</head>

<body>
    <!-- is="x-frame-bypass"  -->
    <!-- <iframe id="myframe" src="http://amis.afa.gov.tw/veg/VegChartProdTransPriceVolumeTrend.aspx" frameborder="0"></iframe> -->
    <div id="app">
        <menu-area></menu-area>
        <show-area></show-area>
    </div>
</body>

</html>


<script>
    // 1.item _______________________________________________________
    var comp_item = Vue.component('item', {
        data: function () {
            return {
            }
        },
        props: {
            name: String,
            val: Object,
            idx: Number,
        },
        template:
            `
                <div @click.stop="toggle"
                    :name_nowbtn="$root.nowbtn[0]"
                    :name="name"
                    :type="val.type"
                    :link="val.link"
                    :class="
                        [
                            'menu-item',
                            {'now': name == $root.nowbtn[0]},
                            {'api_item':name.includes('API')},
                        ]"
                    >
                        {{idx.toString().padStart(2,'0')}}. {{name}}
                </div>
            `
        ,
        methods: {
            toggle() {
                var tmp = [this.name, this.val.type, this.val.link];
                if (this.val.hasOwnProperty('options')) {
                    tmp.push(this.val.options);
                }
                this.$root.nowbtn = tmp;
            }
        }
        ,
        mounted: function () {
            this.$root.count_items += 1;
            // console.log(this.$root.count_items);
        }
    })

    // 2.menu-area _______________________________________________________
    Vue.component('menu-area', {
        data: function () {
            return {
                title: "統計室大全",
                urls: this.$root.urls,
            }
        },
        template:
            `
                <nav :class="{'nav_pin': this.$root.pin}">
                    <div id="menu-title">{{title}}({{this.$root.count_items}})
                        <span
                            :title="this.$root.pin? '不釘選單':'釘住選單'"
                            id="pin" ref='pin'
                            data-pin="{{pin}}"
                            @click.stop="toggle"
                            :class="{'pin_pin': this.$root.pin}"
                        >
                            {{this.$root.pin? 'unpin':'pin'}}
                        </span>
                    </div>
                    <div id="container_items">
                        <item v-for="(val, key, idx) in urls" :val="val" :name="key" :key="idx" :idx="idx+1"></item>
                    </div>
                </nav>
            `
        ,
        components: {
            'item': comp_item
        },
        methods: {
            toggle() {
                this.$root.pin = !this.$root.pin;
            }
        }
    })
    // 3.show-area _______________________________________________________
    Vue.component('show-area', {
        data: function () {
            return {
                ajax_me: function (cors, query, api, ajax_method = 'get', data = {}) {
                    const T = 30;
                    var dataType = 'json';
                    if (api == 'amis') {
                        dataType = 'text';
                    }
                    $.ajax({
                        url: `${cors}${query}`,
                        method: ajax_method,
                        data: data,
                        dataType: dataType,
                        timeout: T * 1000,
                        beforeSend: function () {
                            if (ajax_method == 'get') {
                                $('#apitest').text(query.slice(0, 100) + ".........").attr('href', query);
                            }
                            $('#apires').html(`<h1 style='text-align:center'>API抓取中(超過${T}秒請重新操作)...</h1>`);
                        }
                    })
                        .done(function (res) {
                            console.log(`${cors}${query}`);
                            console.log(res);
                            if (api == 'apis') {
                                var res = res.DATASET;
                            } else if (api == 'amis') {
                                var arr_obj = JSON.parse($(res).text()).DayTransInfo; //用$解析xml為json
                                var res = [];
                                arr_obj.forEach(function (row_obj) {
                                    var detail_arr = row_obj.Detail;
                                    delete row_obj.Detail;
                                    detail_arr.forEach(function (detail_arr_obj) {
                                        res.push({ ...row_obj, ...detail_arr_obj });
                                    });
                                });
                            } else if (api == 'agridataapi') {
                                var res = res.Data;
                            } else if (api.includes('fastpig')) {
                                var res = res.resdata;
                            }
                            //
                            let cols = Object.keys(res[0]);
                            let headerRow = cols
                                .map(col => {
                                    if (api.includes('fastpig')) {
                                        if (['A', 'B', 'C'].includes(col[0])) {
                                            if (['155A', '155B', '155C', '155D'].includes(col.slice(-4))) {
                                                return `<th class='pigDD'>${col}</th>`
                                            } else {
                                                return `<th class='pig${col[0]}'>${col}</th>`
                                            }
                                        } else {
                                            return `<th>${col}</th>`
                                        }
                                    } else {
                                        return `<th>${col}</th>`
                                    }
                                }
                                )
                                .join("");
                            let rows = res
                                .map(row => {
                                    if (row['A1_tw@'] == 0) {
                                        return ''
                                    } else {
                                        let tds = cols.map(col => {
                                            if (api.includes('fastpig')) {
                                                if (col.slice(-3) == 'tw@' || ['A3', 'B3', 'C3'].includes(col)) { //台灣用紅字
                                                    return `<td class='pigWeb PR'>${row[col]}</td>`
                                                } else if (col.slice(-1) == '@') { //不含澎湖用藍字
                                                    return `<td class='pigWeb_T PR'>${row[col]}</td>`
                                                } else if (['A375', 'B375', 'C375', 'C375D'].includes(col)) {
                                                    return `<td class='pig75 PR'>${row[col]}</td>`
                                                } else if (['A395', 'B395', 'C395', 'C395D'].includes(col)) {
                                                    return `<td class='pig95 PR'>${row[col]}</td>`
                                                } else {
                                                    return `<td class='PR'>${row[col]}</td>`
                                                };
                                            } else {
                                                return `<td>${row[col]}</td>`
                                            };
                                        }).join("");
                                        return `<tr>${tds}</tr>`;
                                    }
                                })
                                .join("");
                            //build the table
                            const table = `
                                    <table id='myDataTalbe'>
                                        <thead>
                                            <tr>${headerRow}</tr>
                                        <thead>
                                        <tbody>
                                            ${rows}
                                        <tbody>
                                    <table>
                                `
                                ;
                            $('#apires').html(table);
                            var myDataTalbe = $("#myDataTalbe").DataTable({
                                fixedHeader: true,
                                // responsive: true,
                                //dom: '<"top"Bf>rt<"bottom"lip><"clear">',
                                dom: 'lBfrtip',
                                buttons: [
                                    'copyHtml5',
                                    'excelHtml5',
                                    'csvHtml5',
                                    //'pdfHtml5',
                                    {
                                        text: 'Json',
                                        action: function (e, dt, button, config) {
                                            var data = dt.buttons.exportData();
                                            $.fn.dataTable.fileSave(
                                                new Blob([JSON.stringify(data)]),
                                                'Export.json'
                                            );
                                        }
                                    }
                                ],
                                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                                searching: true, //filter功能
                                columnDefs: [{
                                    targets: [0],
                                    orderable: true,
                                }]
                            });
                            myDataTalbe.fixedHeader.enable();
                        })
                        .fail(function (err) {
                            console.log(`${cors}${query}`);
                            console.log('跨域請求失敗');
                            console.log(err);
                            $('#apires').html(`<pre>${JSON.stringify(err, null, 4)}</pre>`);
                        })

                }
            }
        },
        template:
            `
                <div id="container"
                    :class="{'container_pin':this.$root.pin}"
                    :data="this.$root.nowbtn"
                >
                </div>
            `
        ,
        mounted: function () {
            $("body").on('keypress', '.api input', function (event) {
                if (event.keyCode == 13) {
                    $('.api button').trigger("click");
                };
            });
        },
        updated: function () {
            var cors = this.$root.cors;
            var ajax_me = this.ajax_me;
            var tmp = this.$root.nowbtn;
            var name = tmp[0];
            var type = tmp[1];
            var link = tmp[2];
            //
            if (type == 'web_bypass') {
                var a = `<span style='margin-bottom:5px;margin-top: -7px;'>【若嵌入頁面的操作有問題，請至原始網址: <a href='${link}' target='_blank'>${link}</a>】</span>`;
                $('#container').html(`${a}<iframe is="x-frame-bypass" id="myframe" src="${link}" frameborder="0"></iframe>`);
            } else if (type == 'web') {
                var a = `<span style='margin-bottom:5px;margin-top: -7px;'>【若嵌入頁面的操作有問題，請至原始網址: <a href='${link}' target='_blank'>${link}</a>】</span>`;
                $('#container').html(`${a}<iframe id="myframe" src="${link}" frameborder="0"></iframe>`);
            } else if (type == 'fastdoc') {
                $('#container').html(`<iframe id="myframe" src="${link}" frameborder="0"></iframe>`);
            } else if (type == 'web_blank') {
                var a = `<a href='${link}' target='_blank'>${name}</a>`;
                $('#container').html(`<h1>此網站需另開新頁籤:  ${a}</h1>`)
                // var newW = window.open(link);
                // newW.blur();
                // window.focus();
            } else if (type == 'opendataapi') {
                var options = tmp[3];
                var options_str = options
                    .map(opt =>
                        `
                            <option
                                value="${opt[0].split('_')[0]}.aspx"
                                data-query="${opt[1]}"
                            >
                                ${opt[0]}
                            </option>
                        `
                    )
                    .join("");
                // console.log(options_str);
                var input = `
                        <p class='api'>${link}
                            <select id="open_select">
                                ${options_str}
                            </select>
                            <br>
                            <input value='${options[0][1]}'></input>
                            <br>
                            <button>確認</button>
                            <span style='color:red'>
                                或條件欄位中按【Enter】產生API url:
                                <a id='apitest' target='_blank' style='font-size: 10px;'></a>
                            </span> 
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                $('#open_select').change(function () {
                    var querystr = $(this).find('option:selected').attr('data-query');
                    $('.api input').val(querystr);
                });
                // 確認
                $('.api button').click(function () {
                    var select = $('.api select').val();
                    var val = $('.api input').val();
                    var query = `${link}${select}?${val}`;
                    // console.log(query);
                    ajax_me(cors, query, '');
                    // ajax_me('', query, '');
                });

            } else if (type == 'agridataapi') {
                var options = tmp[3];
                var options_str = options
                    .map(opt =>
                        `
                            <option
                                value="${opt[0].split('__')[0]}"
                                data-query="${opt[1]}"
                            >
                                ${opt[0]}
                            </option>
                        `
                    )
                    .join("");
                // console.log(options_str);
                var input = `
                        <p class='api'>${link}
                            <select id="open_select">
                                ${options_str}
                            </select>
                            <br>
                            <input value='${options[0][1]}'></input>
                            <br>
                            <button>確認</button>
                            <span style='color:red'>
                                或條件欄位中按【Enter】產生API url:
                                <a id='apitest' target='_blank' style='font-size: 10px;'></a>
                            </span> 
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                $('#open_select').change(function () {
                    var querystr = $(this).find('option:selected').attr('data-query');
                    $('.api input').val(querystr);
                });
                // 確認
                $('.api button').click(function () {
                    var select = $('.api select').val();
                    var val = $('.api input').val();
                    var query = `${link}${select}?${val}`;
                    // console.log(query);
                    // ajax_me(cors, query, 'agridataapi');
                    ajax_me('', query, 'agridataapi');
                });

            } else if (type == 'apis') {
                var tmp = link.split('?');
                var link = tmp[0];
                var query = tmp[1];
                var input = `
                        <p class='api'>${link} (青香蕉下品要用<span style='color:red'>status=6</span>)
                            <br>
                            <input value='${query}'></input>
                            <br>
                            <button>確認</button>
                            <span style='color:red'>
                                或條件欄位中按【Enter】產生API url:
                                <a id='apitest' target='_blank' style='font-size: 10px;'></a>
                            </span>
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                // 確認
                $('.api button').click(function () {
                    var val = $('.api input').val();
                    var query = `${link}?${val}`;
                    // console.log(query);
                    ajax_me(cors, query, 'apis');
                });
            } else if (type == 'amis') {
                var tmp = link.split('?');
                var link = tmp[0];
                var query = tmp[1];
                var input = `
                        <p class='api'>${link} <span style='color:red'>(marketType=V,F,L 代表: 蔬菜,水果,花卉)</span>
                            <br>
                            <input value='${query}'></input>
                            <br>
                            <button>確認</button>
                            <span style='color:red'>
                                或條件欄位中按【Enter】產生API url:
                                <a id='apitest' target='_blank' style='font-size: 10px;'></a>
                            </span>
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                // 確認
                $('.api button').click(function () {
                    var val = $('.api input').val();
                    var query = `${link}?${val}`;
                    // console.log(query);
                    ajax_me(cors, query, 'amis');
                    // ajax_me('', query, 'amis');
                });
            } else if (type == 'efish') {
                var tmp = link.split('?');
                var link = tmp[0];
                var query = tmp[1];
                var input = `
                        <p class='api'>${link}
                            (<span style='color:red'>pid/fishId: </span><a target='_blank' style='' href='https://efish.fa.gov.tw/efish/common/atlaslist.htm?keyword='>魚品種代碼表</a>)
                            <br>
                            <input value='${query}'></input>
                            <br>
                            <button>確認</button>
                            <span style='color:red'>
                                或條件欄位中按【Enter】產生API url:
                                <a id='apitest' target='_blank' style='font-size: 10px;'></a>
                            </span>
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                // 確認
                $('.api button').click(function () {
                    var val = $('.api input').val();
                    var query = `${link}?${val}`;
                    // console.log(query);
                    ajax_me(cors, query, 'efish');
                });
            } else if (type == 'tableau') {
                var embed_list = 'https://help.tableau.com/current/pro/desktop/zh-tw/embed_list.htm'
                var obj_default = "<param name='customViews' value='no'/><param name='alerts' value='no'/><param name='showShareOptions' value='no'/><param name='toolbar' value='yes'/>";
                var embed_default = "<script type='text/javascript' src='https://bigdata.coa.gov.tw/javascripts/api/viz_v1.js'><\/script><div class='tableauPlaceholder' style='width: 1366px; height: 571px;'><object class='tableauViz' width='1366' height='571' style='display:none;'><param name='host_url' value='https%3A%2F%2Fbigdata.coa.gov.tw%2F' /> <param name='embed_code_version' value='3' /> <param name='site_root' value='&#47;t&#47;stattab' /><param name='name' value='-&#47;sheet0' /><param name='tabs' value='no' /><param name='toolbar' value='yes' /><param name='showAppBanner' value='false' /></object></div>";
                var input = `
                        <p class='api'>
                            【物件參數】: <input id='obj' value="${obj_default}" placeholder='物件參數請貼我' style='width:50%;'></input>
                            (<a target='_blank' href='${embed_list}'>內嵌代碼表</a>)
                            <br>
                            　【嵌入碼】: <input id='embed' value="${embed_default}" placeholder='嵌入碼請貼我' style='width:50%;'></input>
                            <button>確認</button> 或欄位中按【Enter】，轉圈圈及調整高度等待約 7 秒
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                // 確認
                $('.api button').click(function () {
                    var val_obj = $('input#obj').val();
                    var val_embed = $('input#embed').val().replace("</object>", val_obj + "</object>");
                    //
                    $('#apires').html(val_embed);
                    // 
                    if (val_embed.includes('tableauPlaceholder')) {
                        // 高度處理
                        var reH_ID;
                        window.setTimeout((() => start_reH()), 4000);
                        function start_reH() {
                            reH_ID = window.setInterval(reH, 1000);
                        }
                        function reH() {
                            console.log('start_reH');
                            // 轉圈圈的圖
                            let circle = $("#tableau-svg-spinner-0");
                            if (!circle.is(":visible") && circle.length == 0) {
                                // 等大概4秒畫完圖，壓縮高度
                                var tableauPlaceholder = $('.tableauPlaceholder');
                                tableauPlaceholder.find('iframe').css("height", "100%");
                                tableauPlaceholder.css("height", $('#apires').height());
                                // 
                                window.clearInterval(reH_ID);
                                console.log('畫完');
                            } else {
                                console.log('waiting...');
                            }
                        }
                    } else {

                    }


                });
                // 
                $('.api button').trigger('click');
            } else if (type == 'fastpig') {
                //toLocaleDateString("fr-CA");
                var today = new Date()
                var yesterday = new Date();
                var this_y = today.getFullYear();
                yesterday.setDate(today.getDate() - 1);
                today = today.toLocaleDateString("fr-CA");//toISOString().substring(0, 10);
                yesterday = yesterday.toLocaleDateString("fr-CA");//toISOString().substring(0, 10);
                // console.log(today, yesterday)
                var input = `
                        <p class='api'>
                            <span style='vertical-align:middle'>開始日: </span><input autocomplete="off" value='${yesterday}' id='sd' name='sd' value='' class='date' style='width:8em;margin-right:1em;vertical-align:middle'></input>
                            <span style='vertical-align:middle'>結束日: </span><input autocomplete="off" value='${yesterday}' id='ed' name='ed' value='' calss='date' style='width:8em;vertical-align:middle'></input>
                            <button style='vertical-align:middle'>確認</button>(其他欄位說明請見<span id='doc' style='color:red;cursor:pointer;'>FastAPI</span>)
                            <br> 
                            => 欄名含有 @ 者，為【<a href='http://ppg.naif.org.tw/naif/MarketInformation/Pig/TranStatistics.aspx' target='_blank'>單日多市場價量比較</a>】之數值。無 @ 者為【<a href='http://ppg.naif.org.tw/naif/MarketInformation/Pig/FPSCompare.aspx' target='_blank'>日行情比較</a>】之台灣及澎湖之計算結果。
                            <br>
                            => A1_tw@:台灣豬成交總數, A2@:台灣豬不含澎湖成交總數, A3_tw@:規格豬成交總數, A3@:規格豬不含澎湖成交總數
                            <br>
                            => <span style="color:red">紅字(_tw): 含澎湖</span>。<span style="color:blue">藍字及無_tw: 不含澎湖</span>。
                            <span style="color:green">綠底: 不含澎湖規格豬之新舊計算標準(從各重量層級欄位算出)</span>
                            <br>
                            => A1_tw@ 成交頭數為 0 者，不顯示。A155ABCD,B155ABCD,C155ABCD: 宜蘭,新竹,苗栗,花蓮等四個市場的總頭數/均重/均價。 
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                var picker = {
                    dateFormat: 'yy-mm-dd',
                    changeMonth: true,
                    changeYear: true,
                    yearRange: `1996:${this_y}`,
                    // showButtonPanel: true,
                    beforeShow: function (el, inst) {
                        inst.dpDiv.removeClass('justYM justY').css('padding-bottom', '');
                    }
                }
                $("#sd").datepicker(picker);
                $("#ed").datepicker(picker);
                // 
                $('#doc').click(function () {
                    $('div[type=fastdoc').trigger('click');
                });
                $('.api button').click(function () {
                    var sd = $("#sd").val();
                    var ed = $("#ed").val();

                    if (ed > yesterday) {
                        alert('結束最晚到昨天!');
                        return false;
                    } else if (sd == '' || ed == '') {
                        alert('兩個日期都要輸入!');
                        return false;
                    } else if (sd > ed) {
                        alert('開始要早於結束!');
                        return false;
                    };
                    postdata = { sd, ed };
                    ajax_me('', link, type, 'post', postdata);
                });
            } else if (type == 'fastpig_m') {
                var today = new Date();
                var this_y = today.getFullYear();
                today.setDate(0);// 0 will result in the last day of the previous month
                var last_m = today.toLocaleDateString("fr-CA").substring(0, 7);
                // console.log(today, yesterday)
                var input = `
                        <p class='api'>
                            <span style='vertical-align:middle'>開始月: </span><input autocomplete="off" value='${last_m}' id='sd' name='sd' value='' class='date' style='width:8em;margin-right:1em;vertical-align:middle'></input>
                            <span style='vertical-align:middle'>結束月: </span><input autocomplete="off" value='${last_m}' id='ed' name='ed' value='' calss='date' style='width:8em;vertical-align:middle'></input>
                            <button style='vertical-align:middle'>確認</button> 
                            (使用及欄位說明請見<span id='doc' style='color:red;cursor:pointer;'>FastAPI</span>)
                            <br>
                            => 欄名意義同日行情，資料均從【<a href='http://ppg.naif.org.tw/naif/MarketInformation/Pig/FPSCompare.aspx' target='_blank'>日行情比較</a>】之台灣及澎湖之計算結果。
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                var picker = {
                    dateFormat: 'yy-mm',
                    changeMonth: true,
                    changeYear: true,
                    yearRange: `1996:${this_y}`,
                    // showButtonPanel: true,
                    onClose: function (dateText, inst) {
                        $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
                    },
                    beforeShow: function (el, inst) {
                        inst.dpDiv.css('padding-bottom', '3px').addClass('justYM').removeClass('justY');
                        $('head').append(
                            `
                                <style>
                                    .justYM .ui-datepicker-calendar{
                                        display: none;
                                    }
                                </style>
                            `
                        )
                    }
                }
                $("#sd").datepicker(picker);
                $("#ed").datepicker(picker);
                // 
                $('#doc').click(function () {
                    $('div[type=fastdoc').trigger('click');
                });
                $('.api button').click(function () {
                    var sd = $("#sd").val();
                    var ed = $("#ed").val();

                    if (ed > last_m) {
                        alert('結束最晚到上個月!');
                        return false;
                    } else if (sd == '' || ed == '') {
                        alert('兩個日期都要輸入!');
                        return false;
                    } else if (sd > ed) {
                        alert('開始要早於結束!');
                        return false;
                    };
                    getdata = { sd, ed };
                    ajax_me('', link, type, 'get', getdata);
                });
            } else if (type == 'fastpig_y') {
                var today = new Date()
                var last_y = today.getFullYear() - 1;
                var input = `
                        <p class='api'>
                            <span style='vertical-align:middle'>開始年: </span>
                            <select name="sd" id="sd" style='margin-right:1em;vertical-align:middle'></select>
                            <!--<input value='${last_y}' autocomplete="off" id='sd' name='sd' value='' class='date' style='width:8em;margin-right:1em;vertical-align:middle'></input>-->

                            <span style='vertical-align:middle'>結束年: </span>
                            <select name="ed" id="ed" style='margin-right:0em;vertical-align:middle'></select>
                            <!--<input value='${last_y}' autocomplete="off" id='ed' name='ed' value='' calss='date' style='width:8em;vertical-align:middle'></input>-->

                            <button style='vertical-align:middle'>確認</button> 
                            (使用及欄位說明請見<span id='doc' style='color:red;cursor:pointer;'>FastAPI</span>)
                            <br>
                            => 欄名意義同日行情，資料均從【<a href='http://ppg.naif.org.tw/naif/MarketInformation/Pig/FPSCompare.aspx' target='_blank'>日行情比較</a>】之台灣及澎湖之計算結果。                            
                        </p>
                        <div id='apires'></div>
                    `;
                $('#container').html(input);
                for (var y = 1996; y <= last_y; y++) {
                    $('#sd').append(`<option value=${y}>${y}</option>`);
                    $('#ed').append(`<option value=${y}>${y}</option>`);
                }
                $('#sd').val(last_y);
                $('#ed').val(last_y);
                // var picker = {
                //     dateFormat: 'yy',
                //     changeMonth: false,
                //     changeYear: true,
                //     yearRange: `1996:${last_y}`,
                //     // showButtonPanel: true,
                //     onClose: function (dateText, inst) {
                //         $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
                //     },
                //     beforeShow: function (el, inst) {
                //         inst.dpDiv.css('padding-bottom', '3px').addClass('justY').removeClass('justYM');
                //         $('head').append(
                //             `
                //                 <style>
                //                     .justY {
                //                         width: 150px;
                //                     }
                //                     .justY .ui-datepicker-calendar{
                //                         display: none;
                //                     }
                //                     .justY .ui-datepicker-month {
                //                         display: none;
                //                     }
                //                     .justY .ui-datepicker-prev {
                //                         display: none;
                //                     }
                //                     .justY .ui-datepicker-next {
                //                         display: none;
                //                     }
                //                     .justY .ui-datepicker-title {
                //                         margin:0 1em;
                //                     }
                //                     .justY .ui-datepicker-title .ui-datepicker-year {
                //                         width: 95%;
                //                     }
                //                 </style>
                //             `
                //         )
                //     }
                // }
                // $("#sd").datepicker(picker);
                // $("#ed").datepicker(picker);
                // 
                $('#doc').click(function () {
                    $('div[type=fastdoc').trigger('click');
                });
                $('.api button').click(function () {
                    var sd = $("#sd").val();
                    var ed = $("#ed").val();

                    if (ed > last_y.toString()) {
                        alert('結束最晚到去年!');
                        return false;
                    } else if (sd == '' || ed == '') {
                        alert('兩個日期都要輸入!');
                        return false;
                    } else if (sd > ed) {
                        alert('開始要早於結束!');
                        return false;
                    };
                    getdata = { sd, ed };
                    ajax_me('', link, type, 'get', getdata);
                });
            } else if (type == 'fastpig_dayplot') {
                var container = $("#container");
                var cw = container.width();
                var ch = container.height();
                // console.log(container.width(), container.height());
                container.empty();
                // set the dimensions and margins of the graph
                var margin = { top: 10, right: 50, bottom: 30, left: 30 },
                    width = cw - margin.left - margin.right,
                    height = ch - margin.top - margin.bottom - 75;
                // 
                var div = d3.select("#container").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0)
                    ;
                // append the svg object to the body of the page
                var svg = d3.select("#container")
                    .append("svg")
                    .attr("width", '100%')
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                // 
                var sd = '2010-01-01';
                var ed = new Date();
                ed.setDate(ed.getDate() - 1);
                ed = ed.toLocaleDateString("fr-CA");
                const dr = { sd, ed };
                // 
                d3.json(link, {
                    method: "POST",
                    body: JSON.stringify(dr),
                    // timeout: 1,
                    // headers: {
                    //     "Content-type": "application/json; charset=UTF-8"
                    // }
                })
                    .then(res => {
                        // const data = res.resdata.map(row => [row.B3, row.C3]);
                        const data = res.resdata.map(row => [row.date, row['C3@']]);
                        // console.log(data);
                        // (1) X____________________________________
                        // var x = d3.scaleLinear()
                        //     .domain([80, 140])
                        //     .range([0, width]);
                        // var count = data.length;
                        var minDate = new Date(sd);
                        var maxDate = new Date(ed);
                        // console.log(minDate, maxDate);
                        var x = d3.scaleTime().domain([minDate, maxDate]).range([0, width]);
                        svg.append("g")
                            .attr("transform", "translate(0," + height + ")")
                            .call(d3.axisBottom(x));
                        // (2) Y______________________________________
                        var y = d3.scaleLinear()
                            .domain([50, 90])
                            .range([height, 0]);
                        svg.append("g")
                            .call(d3.axisLeft(y));
                        // (3) Dots____________________________________
                        svg.append('g')
                            .selectAll("dot")
                            .data(data)
                            .enter()
                            .append("circle")
                            // .attr("cx", d => x(d[0]))
                            .attr("cx", d => x(new Date(d[0])))
                            .attr("cy", d => y(d[1]))
                            .on("mouseover", function (event, d) {
                                d3.select(this)
                                    .style('fill', 'green')
                                    .attr("r", d => 6)
                                    ;
                                // alert(div);
                                div.transition()
                                    .duration(200)
                                    .style("opacity", .9);
                                div.html(`日期:${d[0]}<br/>價格:${d[1]}`)
                                    .style("left", (event.pageX - 50) + "px")
                                    .style("top", (event.pageY - 52) + "px");
                            })
                            .on("mouseout", function (d) {
                                d3.select(this)
                                    .attr("r", d => Math.pow(d[1] / 75, 5) + 0.6)
                                    .style("fill", d => d[1] >= 80 ? "#ff0000" : "#69b3a2")
                                    ;
                                div.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                            })
                            .attr("w_p", d => `${d[0]}_${d[1]}`)
                            .attr("r", d => Math.pow(d[1] / 75, 5) + 1)
                            .style("fill", d => d[1] >= 80 ? "#ff0000" : "#69b3a2")
                            .style("cursor", "pointer")
                            // .append('title')
                            // .text(d => `${d[0]}_${d[1]}`)
                            ;
                        // 
                        container.append(
                            `
                                <div style='padding-left:1em'>
                                    <p style='margin-bottom: -0.7em;'>
                                        <span style='font-weight:bold'>橫軸</span>: 日期從${sd}至${ed}
                                    </p>
                                    <p>
                                        <span style='font-weight:bold'>縱軸</span>: 日行情的成交價格，<span style='color:red'>紅色代表80以上</span>，滑鼠滑過圓點可顯示日期及價格
                                    </p>
                                </div>
                            `
                        )

                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                ;
            }
            //if

        }
    })
    // 4.APP _______________________________________________________
    var app = new Vue({
        el: '#app',
        data: {
            pin: true,
            count_items: 0,
            nowbtn: [],
            cors: 'https://cors-anywhere.herokuapp.com/',
            urls: {
                'API_OpenData':
                {
                    'type': 'opendataapi',
                    'link': 'https://data.coa.gov.tw/Service/OpenData/',
                    'options': [
                        ['FromM/FarmTransData_蔬果批發行情', 'StartDate=109.09.22&Market=台北'],
                        ['FromM/AnimalTransData_毛豬(批發)', 'TransDate=1090922&MarketName='],
                        ['FromM/AquaticTransData_漁批發', 'StartDate=1090923&EndDate=1090923&TypeNo='],
                        ['FromM/PoultryTransBoiledChickenData_白肉雞、雞蛋(產地)', 'StartDate=2020/08/01&EndDate=2020/09/30'],
                        ['FromM/PoultryTransLocalRedChickenData_紅羽土雞(產地)', 'StartDate=2020/08/01&EndDate=2020/09/30'],
                        ['FromM/PoultryTransLocalBlackChickenData_黑羽土雞', 'StartDate=2020/08/01&EndDate=2020/09/30'],
                        ['FromM/PoultryTransGooseDuckData_鴨(產地)', 'StartDate=2020/08/01&EndDate=2020/09/30'],
                        ['FromM/PoultryTransGooseDailyPriceData_鵝(產地)', 'StartDate=2020/08/01&EndDate=2020/09/30'],
                        ['FromM/SheepTransData_羊(批發)', '$filter=transDate+like+2020/01/09+and+shortName+like+彰化縣+and+productName+like+努比亞雜交閹公羊'],
                        ['BeefPriceService_牛', ''],
                        ['Ricepriceavg_全國單日平均糧價', 'startDate=2020/09/01&endDate=2020/09/12'],
                        ['FromM/RicepriceData_全國單日各縣市糧價', 'startDate=2020/09/01&endDate=2020/09/12'],
                    ]
                },
                'API_AgriData':
                {
                    'type': 'agridataapi',
                    'link': 'https://agridata.coa.gov.tw/api/v1/',
                    'options': [
                        ['AgriProductsTransType__農產品交易行情', 'Start_time=109.11.09&End_time=109.11.09&Market=台北'],
                        ['PorkTransType__毛豬交易行情', 'TransDate=1091109&MarketName='],
                        ['FisheryProductsTransType__漁產品交易行情', 'Start_time=1090923&End_time=1090923&TypeNo='],
                        ['PoultryTransType_BoiledChicken_Eggs__家禽交易行情(白肉雞/雞蛋)', 'Start_time=2020/08/01&End_time=2020/09/30'],
                        ['PoultryTransType_RedFeather__家禽交易行情(紅羽土雞)', 'Start_time=2020/08/01&End_time=2020/09/30'],
                        ['PoultryTransType_BlackFeather__家禽交易行情(黑羽土雞)', 'Start_time=2020/08/01&End_time=2020/09/30'],
                        ['PoultryTransType_Chicken__家禽交易行情(土雞)', 'Start_time=2020/08/01&End_time=2020/09/30'],
                        ['PoultryTransType_Goose_Duck_Duckegg__家禽交易行情(肉鵝/番鴨/鴨蛋)', 'Start_time=2020/08/01&End_time=2020/09/30'],
                        ['PoultryTransType_Goose_Day__家禽交易行情(養鵝協會當日行情)', 'Start_time=2020/08/01&End_time=2020/09/30'],
                        ['SheepTransType_Day__市場羊隻日行情資料', 'TransDate=2020/01/09'],
                        // ['BeefPriceService_牛', ''],
                        // ['Ricepriceavg_全國單日平均糧價', 'startDate=2020/09/01&endDate=2020/09/12'],
                        // ['FromM/RicepriceData_全國單日各縣市糧價', 'startDate=2020/09/01&endDate=2020/09/12'],
                        ['FisheryProductsTransType__漁產品交易行情', 'Start_time=1090801&End_time=1090930&SeafoodProdCode=1174'],
                    ]
                },
                'API_apis 農糧署_蔬果產地': {
                    'type': 'apis',
                    'link': 'https://apis.afa.gov.tw/webservice/opendata.asmx/queryPrice?status=4&startYear=2020&startMonth=9&startDay=20&endYear=2020&endMonth=9&endDay=20&productname='
                },
                'API_amis農糧署_批發合計': {
                    'type': 'amis',
                    'link': 'http://amis.afa.gov.tw/PlatformService.asmx/GetStatsticsForCOA?marketType=L&marketNo=ALL&transDate=1090901&bigType=FH',
                },
                'API_efish漁業署_漁產地': {
                    'type': 'efish',
                    'link': 'https://efish.fa.gov.tw/efish/statistics/svc/downloadtradepricedata?ds=109.09.01&de=109.09.10&tk=3ec536a2-3db0-4791-88aa-b28ccc4a835f&pid=1174',
                },
                'API_規格豬_日行情': {
                    'type': 'fastpig',
                    'link': 'https://wtb.wtbwtb.tk/fastapi/pig/',
                },
                'API_規格豬_月行情': {
                    'type': 'fastpig_m',
                    'link': 'https://wtb.wtbwtb.tk/fastapi/pig_m/',
                },
                'API_規格豬_年行情': {
                    'type': 'fastpig_y',
                    'link': 'https://wtb.wtbwtb.tk/fastapi/pig_y/',
                },
                'API_規格豬_日行情走勢': {
                    'type': 'fastpig_dayplot',
                    'link': 'https://wtb.wtbwtb.tk/fastapi/pig/',
                },
                'API_規格豬行情_FastAPI': {
                    'type': 'fastdoc',
                    'link': 'https://wtb.wtbwtb.tk/fastapi/doc/',
                    // 'link': 'http://wtb.wtbwtb.tk:5001/docs',   
                },
                // ============================================================== 
                'AgriData.coa資料服務平台': {
                    'type': 'web_bypass',
                    'link': 'https://agridata.coa.gov.tw/api.aspx'
                },
                'Data.coa資料開放平台': {
                    'type': 'web_blank',
                    'link': 'https://data.coa.gov.tw/Query/ServiceDetail.aspx?id=037'
                },
                '農產品批發市場交易行情站': {
                    'type': 'web',
                    'link': 'http://amis.afa.gov.tw/veg/VegChartProdTransPriceVolumeTrend.aspx'
                },
                '農產品產地價格查報系統': {
                    'type': 'web_blank',
                    'link': 'https://apis.afa.gov.tw/pagepub/AppInquiryPage.aspx'
                },
                '畜產品價格查詢系統': {
                    'type': 'web',
                    'link': 'http://price.naif.org.tw/Query/Query_now.aspx'
                },
                '畜產行情資訊網': {
                    'type': 'web_blank',
                    'link': 'http://ppg.naif.org.tw/naif/MarketInformation/Poultry/TranStatistics.aspx'
                },
                '畜牧農情調查資訊系統': {
                    'type': 'web_bypass',
                    'link': 'https://asis.coa.gov.tw/imita_login.php'
                },
                '中央畜產會': {
                    'type': 'web',
                    'link': 'https://www.naif.org.tw/main.aspx'
                },
                '國產豬標章證明地圖': {
                    'type': 'web',
                    // 'link': 'https://map.coa.gov.tw/tp/#'
                    'link': 'https://scene.coa.gov.tw/taiwanpork/#'
                },
                '豬肉儀表板': {
                    'type': 'web',
                    'link': 'https://ifi.fda.gov.tw/ifi/pfp/cp/pfpcp0706q.jsp'
                },
                '養雞協會': {
                    'type': 'web',
                    'link': 'http://www.poultry.org.tw/'
                },
                '動植物防檢局': {
                    'type': 'web_bypass',
                    'link': 'https://www.baphiq.gov.tw/ws.php?id=8245'
                },
                '漁產品全球資訊網': {
                    'type': 'web_blank',
                    'link': 'https://efish.fa.gov.tw/efish/statistics/trendchart.htm'
                },
                '查詢糧價日平均-依縣市': {
                    'type': 'web_blank',
                    'link': 'https://foodinformation.afa.gov.tw/Search/S02/S0201/S02010201.aspx?sys_id=S02&sys_pid=S02010201'
                },
                '田邊好幫手': {
                    'type': 'web_blank',
                    'link': 'https://m.coa.gov.tw/Transaction/RicePrice/Index'
                },
                '農業統計視覺化查詢網': {
                    'type': 'web_bypass',
                    'link': 'https://statview.coa.gov.tw/aqsys_on/index.html#'
                },
                '█ 勞動力調查平台': {
                    'type': 'web_blank',
                    'link': 'https://alss.atri.org.tw/'
                },
                '█ 每日價量平台': {
                    'type': 'web_blank',
                    'link': 'https://aprp.atri.org.tw/accounts/login/'
                },
                '三節報表_測試': {
                    'type': 'web_blank',
                    'link': 'http://132.145.121.250:8000'
                },
                'Tableau_測試_貿易': {
                    'type': 'web_blank',
                    'link': 'http://132.145.121.250/'
                },
                'Tableau_測試_embed': {
                    'type': 'tableau',
                    'link': ''
                },
                'Tableau_Public_貿易': {
                    'type': 'web_blank',
                    'link': 'https://public.tableau.com/profile/coastat#!/'
                },
                '農委會統計與出版品': {
                    'type': 'web_blank',
                    'link': 'https://www.coa.gov.tw/ws.php?id=8'
                },
                '漁業署統計與出版品': {
                    'type': 'web',
                    'link': 'https://www.fa.gov.tw/cht/Publications/index.aspx'
                },
                '中研院輿情分析系統': {
                    'type': 'web',
                    'link': 'https://ckip.iis.sinica.edu.tw/service/opinion/'
                },
                '環境教育終身學習網': {
                    'type': 'web_blank',
                    'link': 'https://elearn.epa.gov.tw/default.aspx'
                },
                '教育統計動態視覺化平臺': {
                    'type': 'web_bypass',
                    'link': 'https://stats.moe.gov.tw/statedu/'
                },
                '內政部_地理資訊系統': {
                    'type': 'web_bypass',
                    'link': 'https://moisagis.moi.gov.tw/moiap/gis2010/pro/index.cfm'
                },
                '內政部_戶役政資料代碼': {
                    'type': 'web_bypass',
                    'link': 'https://www.ris.gov.tw/documents/html/5/1/168.html'
                },
                '內政部_段名代碼查詢系統': {
                    'type': 'web_blank',
                    'link': 'http://lisp.land.moi.gov.tw/MMS/MMSpage.aspx#gobox02'
                },
                '中華電信農民整合資料庫': {
                    'type': 'web_blank',
                    'link': 'https://coamdm.coa.gov.tw/member'
                },

            }
        }
    })
    // 
    $('.menu-item').eq(0).trigger('click');
</script>